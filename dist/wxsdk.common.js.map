{"version":3,"file":"wxsdk.common.js","sources":["../src/utils.js","../src/core.js","../src/overide/wx.js","../src/overide/index.js","../src/index.js"],"sourcesContent":["export const warn = (message, isWarn) => {\r\n  message = `\\n[ReportSDK warn]: ${message}\\n\\n`\r\n  if (isWarn) {\r\n    console.warn(message)\r\n    console.log(121)\r\n    return\r\n  }\r\n  throw new Error(message)\r\n}\r\n\r\nexport const assert = (condition, error) => {\r\n  if (condition) {\r\n    warn(error)\r\n  }\r\n}\r\n\r\nexport const isUndef = v => {\r\n  return v === null || v === undefined\r\n}\r\n\r\nexport const callHook = (hooks, name, params) => {\r\n  if (hooks && typeof hooks[name] === 'function') {\r\n    return [true, hooks[name].apply(hooks, params)]\r\n  }\r\n  return [false, null]\r\n}\r\n\r\nexport const remove = (list, item) => {\r\n  const index = list.indexOf(item)\r\n  if (~index) {\r\n    list.splice(index, 1)\r\n  }\r\n}\r\n\r\nexport const createWraper = (target, fn) => {\r\n  return function (...args) {\r\n    fn.apply(this, args)\r\n    if (typeof target === 'function') {\r\n      return target.apply(this, args)\r\n    }\r\n  }\r\n}\r\n\r\nexport const isPlainObject = obj => {\r\n  if (typeof obj !== 'object' || obj === null) return false\r\n\r\n  const proto = Object.getPrototypeOf(obj)\r\n  if (proto === null) return true\r\n\r\n  let baseProto = proto\r\n  while (Object.getPrototypeOf(baseProto) !== null) {\r\n    baseProto = Object.getPrototypeOf(baseProto)\r\n  }\r\n  return proto === baseProto\r\n}","import { assert, isUndef, callHook } from './utils'\r\n\r\nexport default class SDK {\r\n  constructor (opts) {\r\n    this.opts = opts\r\n    this.hooks = opts.hooks\r\n    this.depComponents = new Map()\r\n    this.timeStack = Object.create(null)\r\n  }\r\n\r\n  time (type) {\r\n    if (typeof type === 'string') {\r\n      if (isUndef(this.timeStack[type])) {\r\n        this.timeStack[type] = Date.now()\r\n      }\r\n    }\r\n  }\r\n\r\n  timeEnd (type, fn) {\r\n    if (typeof type === 'string') {\r\n      if (!isUndef(this.timeStack[type])) {\r\n        const duration = Date.now() - this.timeStack[type]\r\n        typeof fn === 'function' && fn(duration)\r\n        this.timeStack[type] = null\r\n        return duration\r\n      }\r\n    }\r\n    return null\r\n  }\r\n\r\n  // 调用数据上报的钩子\r\n  // 网络请求等具体的副作用暴露给外部\r\n  report (key, payload) {\r\n    const [success, res] = callHook(this.hooks, 'report', [key, payload])\r\n    assert(!success, 'The [report] hooks is not defined.')\r\n    return res\r\n  }\r\n}","export default (sdk, rewrite) => {\r\n  // 重写导航方法\r\n  rewrite('navigateTo', function () {\r\n\r\n  })\r\n}","import overideWX from './wx'\r\nimport { load, unLoad } from '../handle-config'\r\nimport { createWraper, isPlainObject, assert } from '../utils'\r\n\r\nexport const SDKCfgNamespace = 'SDKConfig'\r\n\r\n/**\r\n * 数据统计的具体实现思路\r\n *  1. 需要对各种时长进行统计\r\n *  2. 对页面点击的埋点统计\r\n *  3. 自定业务逻辑的埋点统计\r\n *  4. 向外暴露的 api\r\n */\r\n\r\n// 重写 component 和 page 的 config\r\nexport function overideComponent (sdk, config, isPage) {\r\n  const SDKConfig = config[SDKCfgNamespace]\r\n  const canProcessCfg = isPlainObject(SDKConfig)\r\n\r\n  // Page\r\n  if (isPage) {\r\n    const nativeLoad = config.onLoad\r\n    const nativeUnload = config.onUnload\r\n\r\n    // rewritte load hooks\r\n    config.onLoad = createWraper(\r\n      nativeLoad,\r\n      function () {\r\n        sdk.depComponentData.set(this, true)\r\n        if (canProcessCfg) {\r\n          this[SDKCfgNamespace] = SDKConfig\r\n          load(sdk, this, SDKConfig, true)\r\n        }\r\n      },\r\n    )\r\n\r\n    // rewritte unload hook\r\n    config.onUnload = createWraper(\r\n      nativeUnload,\r\n      function () {\r\n        sdk.depComponentData.delete(this)\r\n        if (canProcessCfg) {\r\n          unLoad(sdk, this, SDKConfig, true)\r\n          this[SDKCfgNamespace] = null\r\n        }\r\n      },\r\n    )\r\n  } else {\r\n    // Component\r\n    config.lifetimes = config.lifetimes || {}\r\n    const nativeAttached = config.attached || config.lifetimes.attached\r\n    const nativeDetached = config.detached || config.lifetimes.detached\r\n\r\n    config.attached =\r\n    config.lifetimes.attached = createWraper(\r\n      nativeAttached,\r\n      function () {\r\n        sdk.depComponents.set(this, false)\r\n        if (canProcessCfg) {\r\n          this[SDKCfgNamespace] = SDKConfig\r\n          load(sdk, this, SDKConfig, true)\r\n        }\r\n      },\r\n    )\r\n\r\n    config.detached =\r\n    config.lifetimes.detached = createWraper(\r\n      nativeDetached,\r\n      function () {\r\n        sdk.depComponents.delete(this)\r\n        if (canProcessCfg) {\r\n          unLoad(sdk, this, SDKConfig, true)\r\n          this[SDKCfgNamespace] = null\r\n        }\r\n      },\r\n    )\r\n  }\r\n  return config\r\n}\r\n\r\n// 重写 app 的 config\r\nexport function overideApp (sdk, config) {\r\n  const nativeShow = config.onShow\r\n  const nativeHide = config.onHide\r\n  const nativeError = config.onError\r\n  const nativeLaunch = config.onLaunch\r\n\r\n  config.onLaunch = createWraper(\r\n    nativeLaunch,\r\n    function () {\r\n      // 记录初始化的时长\r\n      const duration = sdk.timeEnd('startTime')\r\n      sdk.report('startTime', duration)\r\n    },\r\n  )\r\n\r\n  config.onShow = createWraper(\r\n    nativeShow,\r\n    function () {\r\n      // 记录当前 app 从显示到隐藏，一共停留的时长\r\n      sdk.time('showTime')\r\n    },\r\n  )\r\n\r\n  config.onHide = createWraper(\r\n    nativeHide,\r\n    function () {\r\n      const duration = sdk.timeEnd('showTime')\r\n      sdk.report('showTime', duration)\r\n    },\r\n  )\r\n\r\n  config.onError = createWraper(\r\n    nativeError,\r\n    function (errMsg) {\r\n      // 自动上报在 app 里面捕获到的错误\r\n      sdk.report('globalCatchError', errMsg)\r\n    },\r\n  )\r\n\r\n  return config\r\n}\r\n\r\n// 重写 wx 类\r\nexport function overideWxClass (sdk, nativeWX) {\r\n  const overideClass = {}\r\n\r\n  overideWX(sdk, (name, fn) => {\r\n    // 只允许重写，不允许新增\r\n    // 如果需要新增全局方法，不应该写在这里\r\n    assert(!(name in nativeWX), 'Only allowed to rewrite.')\r\n    assert(name in overideClass, `${name} has been rewritten`)\r\n    overideClass[name] = createWraper(nativeWX[name], fn)\r\n  })\r\n\r\n  wx = Object.assign({}, nativeWX, overideClass)\r\n}","import SDK from './core'\r\nimport { overideApp, overideComponent, overideWxClass } from './overide'\r\n\r\nlet isInitComplete = false\r\n\r\nconst nativeWX = wx\r\nconst nativeApp = App\r\nconst nativePage = Page\r\nconst nativeComponent = Component\r\n\r\nconst filterOpts = opts => {\r\n  return opts\r\n}\r\n\r\nexport default function (opts) {\r\n  if (isInitComplete) {\r\n    warn('Can\\'t allow repeat initialize.')\r\n  }\r\n\r\n  const sdk = new SDK(filterOpts(opts))\r\n\r\n  // 记录项目启动时的时机点\r\n  sdk.time('startTime')\r\n\r\n  Page = function (config) {\r\n    config = overideComponent(sdk, config, true)\r\n    return nativePage.call(this, config)\r\n  }\r\n  Component = function (config) {\r\n    config = overideComponent(this, sdk, config, false)\r\n    return nativeComponent.call(this, config)\r\n  }\r\n  App = function (config) {\r\n    config = overideApp(this, sdk, config)\r\n    return nativeApp.call(this, config)\r\n  }\r\n  // 重写 wx 原生类\r\n  overideWxClass(sdk, nativeWX)\r\n\r\n  isInitComplete = true\r\n  return sdk\r\n}"],"names":["warn","message","isWarn","console","log","Error","assert","condition","error","isUndef","v","undefined","callHook","hooks","name","params","apply","createWraper","target","fn","args","isPlainObject","obj","proto","Object","getPrototypeOf","baseProto","SDK","constructor","opts","depComponents","Map","timeStack","create","time","type","Date","now","timeEnd","duration","report","key","payload","success","res","sdk","rewrite","SDKCfgNamespace","overideComponent","config","isPage","SDKConfig","canProcessCfg","nativeLoad","onLoad","nativeUnload","onUnload","depComponentData","set","load","delete","unLoad","lifetimes","nativeAttached","attached","nativeDetached","detached","overideApp","nativeShow","onShow","nativeHide","onHide","nativeError","onError","nativeLaunch","onLaunch","errMsg","overideWxClass","nativeWX","overideClass","overideWX","wx","assign","isInitComplete","nativeApp","App","nativePage","Page","nativeComponent","Component","filterOpts","call"],"mappings":"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"}