"use strict";function getLegalTimeType(t){var e=t.Utils.randomId();return t.timeStack[e]?getLegalTimeType(t):e}function recordRequestTime(t){t.NetWork.on("request",(function(e){if(e.record){var n=getLegalTimeType(t);t.time(n),e.complete=t.Utils.createWraper(e.complete,(function(){var r=t.timeEnd(n);console.log(e.url,r)}))}}))}Object.defineProperty(exports,"__esModule",{value:!0});var warn=function(t,e){if(t="\n[SDK warn]: "+t+"\n\n",!e)throw new Error(t);console.warn(t)},assert=function(t,e){t||warn(e)},isUndef=function(t){return null==t},once=function(t){var e=!0;return function(){for(var n=[],r=0;r<arguments.length;r++)n[r]=arguments[r];if(e)return e=!1,t.apply(this,n)}},mapObject=function(t,e){var n={};for(var r in t)n[r]=e(r,t[r]);return n},createWraper=function(t,e,n){return function(){for(var r,o=[],i=0;i<arguments.length;i++)o[i]=arguments[i];return"function"==typeof e&&e.apply(this,o),"function"==typeof t&&(r=t.apply(this,o)),"function"==typeof n&&n.apply(this,o),r}};function listenerButton(t,e){assert(!!e,"The [options] must be an object"),assert("function"==typeof e.sendData,"You must defined [sendData] function"),t.Template.on("event",(function(n,r,o){var i=e.sendData({tp:0,sp:"stat",t:Date.now(),bm:"clickButton",exd:{type:n,value:r},unid:t.Utils.unid(),p:(t.Utils.getCurrentPage()||{route:""}).route},o);assert("object"==typeof i,"the report data must be an object"),t.Utils.report(t.options.url,i,"GET")}))}var index=Object.freeze({recordRequestTime:recordRequestTime,listenerButton:listenerButton}),pageLifeTime="onLoad,onShow,onReady,onHide,onUnload",componentLifeTime="created,attached,ready,moved,detached",appLifeTime="onLaunch,onShow,onHide,onError,onPageNotFound";function injectToComponent(t,e){mapObject(e,(function(e,n){t[e]=n}))}function dispatch(t,e,n,r,o,i){if("onLoad"===t||"attached"===t){e.depComponents.set(n,r),injectToComponent(n,{dusk:e});var a=n.setData;n.setData=function(t,n){a.call(this,t,createWraper(n,(function(){e.emit("setData",[t])})))}}"onUnload"!==t&&"detached"!==t||e.depComponents.delete(n),e.emit(t,[n,o,i,r])}function overideApp(t,e){return appLifeTime.split(",").forEach((function(n){e[n]=createWraper(e[n],(function(r){t.emit(n,[this,r,e])}))})),e}function overidePage(t,e){return pageLifeTime.split(",").forEach((function(n){e[n]=createWraper(e[n],(function(r){dispatch(n,t,this,!0,r,e)}))})),e}function overideComponent(t,e){e.lifetimes=e.lifetimes||{};return componentLifeTime.split(",").forEach((function(n){var r;!function(t,n){e[t]=e.lifetimes[t]=n}(n,createWraper((r=n,e[r]||e.lifetimes[r]),(function(r){dispatch(n,t,this,!1,r,e)})))})),e}var extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)};function __extends(t,e){function n(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}function getEventModule(t,e){return t._listener[e]||(t._listener[e]={once:[],normal:[]})}var Event=function(){function t(){this._listener=Object.create(null)}return t.prototype.on=function(t,e){return("string"==typeof t||"function"==typeof e)&&(getEventModule(this,t).normal.push(e),!0)},t.prototype.once=function(t,e){return("string"==typeof t||"function"==typeof e)&&(getEventModule(this,t).once.push(e),!0)},t.prototype.off=function(t,e){var n=this._listener[t];if(n){if("function"==typeof e){var r=-1,o=n.once,i=n.normal;~(r=o.indexOf(e))&&o.splice(r,1),~(r=i.indexOf(e))&&o.splice(r,1)}else void 0===e&&(n.once=[],n.normal=[]);return!0}return!1},t.prototype.offAll=function(){this._listener=Object.create(null)},t.prototype.emit=function(t,e){var n=this;void 0===e&&(e=[]);var r=this._listener[t];return!!r&&(r.once.forEach((function(t){return t.apply(n,e)})),r.once=[],r.normal.forEach((function(t){return t.apply(n,e)})),!0)},t}(),Utils={once:once,createWraper:createWraper,uuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))},unid:function(){return"za-"+parseInt(Math.random().toString().slice(-6)).toString(16)+"-"+parseInt(Date.now()).toString(16)},randomId:function(t,e,n){return void 0===t&&(t=1e6),void 0===e&&(e=0),void 0===n&&(n=0),Number(Math.random()*(t-e)+e).toFixed(n)},getCurrentPage:function(){var t=getCurrentPages();return Array.isArray(t)&&t.length>0?t[t.length-1]:null},report:function(t,e,n,r){return void 0===r&&(r={}),new Promise((function(o){wx.request({url:t,data:e,method:n,header:r,complete:o})}))}},Router=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Event),NetWork=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e}(Event);function expandExtrcMethods(t,e,n){function r(e){t.Template.acceptDuskEvent(this,e,n)}n?e.duskEvent=r:e.methods?e.methods.duskEvent=r:e.methods={duskEvent:r}}var DATANAMESPACE="dusk";function getResult(t){var e=t.mark,n=t.target.dataset;return e&&e[DATANAMESPACE]||n[DATANAMESPACE]}var Template=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.acceptDuskEvent=function(t,e,n){var r=e.type,o=getResult(e);o&&this.emit("event",[r,o,function(){return{isPage:n,event:e,component:t}}])},e}(Event);function filterOptions(t){return assert("string"==typeof t.url,"The report url must be a string"),t}var Dusk=function(t){function e(e){var n=t.call(this)||this;return n.version="0.0.1",n.Utils=Utils,n.Router=new Router,n.NetWork=new NetWork,n.Template=new Template,n.types=[],n.timeStack=Object.create(null),n.depComponents=new Map,n.installedPlugins=new Set,n.options=filterOptions(e||{}),n}return __extends(e,t),e.prototype.report=function(t,e){assert(this.types.includes(t),"The ["+t+"] is not rigister."),this.emit("report",[t,e])},e.prototype.addPlugin=function(t){for(var e=[],n=1;n<arguments.length;n++)e[n-1]=arguments[n];return assert(!this.installedPlugins.has(t),"Don't repeat install plugin"),e.unshift(this),this.installedPlugins.add(t),t.apply(null,e)},e.prototype.time=function(t){"string"==typeof t&&isUndef(this.timeStack[t])?this.timeStack[t]=Date.now():warn("Timer ["+t+"] already exists.",!0)},e.prototype.timeEnd=function(t,e){if("string"==typeof t){var n=this.timeStack[t];if(!isUndef(n)){var r=Date.now()-n;return"function"==typeof e&&e(r),this.timeStack[t]=null,r}}return warn("Timer ["+t+"] already exists."),null},e}(Event),nativeWX=wx;function overiddenWX(t,e){"reLaunch,switchTab,navigateTo,redirectTo".split(",").forEach((function(n){e(n,(function(e){t.Router.emit(n,[e])}))}));"request".split(",").forEach((function(n){e(n,(function(e){t.NetWork.emit(n,e)}))}))}function overiddenWX$1(t){var e={};overiddenWX(t,(function(t,n){assert(t in nativeWX,"Can't allowed add new method."),assert(!(t in e),"["+t+"] has been rewritten"),e[t]=createWraper(nativeWX[t],n)})),wx=Object.assign({},nativeWX,e)}var nativeApp=App,nativePage=Page,nativeComponent=Component,isInitComplete=!1;function createDuskInstance(t){assert(!isInitComplete,"Can't allow repeat initialize."),isInitComplete=!0;var e=new Dusk(t);return Page=function(t){return t=overidePage(e,t),e.emit("pageCreateBefore",[t]),expandExtrcMethods(e,t,!0),nativePage.call(this,t)},Component=function(t){return t=overideComponent(e,t),e.emit("ComponentCreateBefore",[t]),expandExtrcMethods(e,t,!1),nativeComponent.call(this,t)},App=function(t){return t=overideApp(e,t),e.emit("appCreateBefore",[t]),expandExtrcMethods(e,t,!0),nativeApp.call(this,t)},overiddenWX$1(e),e}exports.createDuskInstance=createDuskInstance,exports.plugins=index;
