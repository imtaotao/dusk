"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const warn=(e,t)=>{if(e=`\n[SDK warn]: ${e}\n\n`,!t)throw new Error(e);console.warn(e)},assert=(e,t)=>{e&&warn(t)},once=e=>{let t=!1;return function(){if(!t)return t=!0,e.apply(this,arguments)}},isUndef=e=>null==e,callHook=(e,t,o)=>e&&"function"==typeof e[t]?e[t].apply(e,o):null,createWraper=(e,t)=>(function(...o){if(t.apply(this,o),"function"==typeof e)return e.apply(this,o)}),isPlainObject=e=>{if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);if(null===t)return!0;let o=t;for(;null!==Object.getPrototypeOf(o);)o=Object.getPrototypeOf(o);return t===o};class Router{constructor(e){this.sdk=e}report(e,t){t.type=e,this.sdk.report("router",t)}reportError(e,t){t.type=e,this.sdk.report("routerError",t)}getCurrentPage(){const e=getCurrentPages();return Array.isArray(e)&&e.length>0?e[e.length-1]:null}}var handleConfigHooks={app:{},page:{onLoad(e,t,o,r){},onUnLoad(e,t,o,r){}},component:{},update(e,t,o){}};const reportCodes={catchGlobalError:11,routerError:130,router:30},addCode=(e,t)=>{assert(e in reportCodes,`The [${e}] already exists.`),reportCodes[e]=t},getCode=e=>(assert(!(e in reportCodes),`Code [${e}] is does not exist.`),reportCodes[e]);class SDK{constructor(e){this.opts=e,this.reportStack={},this.hooks=e.hooks,this.depComponents=new Map,this.router=new Router(this),this.reportCodes=reportCodes,this.installedPlugins=new Set,this.timeStack=Object.create(null)}once(e){return once(e)}wraper(e,t){return createWraper(e,t)}addCode(e,t){addCode(e,t)}time(e){"string"==typeof e&&(isUndef(this.timeStack[e])?this.timeStack[e]=Date.now():warn(`Timer [${e}] already exists.`,!0))}timeEnd(e,t){if("string"==typeof e){if(!isUndef(this.timeStack[e])){const o=Date.now()-this.timeStack[e];return"function"==typeof t&&t(o),this.timeStack[e]=null,o}warn(`Timer [${e}] does not exist.`,!0)}return null}report(e,t){e=getCode(e),isUndef(this.reportStack[e])?(this.reportStack[e]=[t],setTimeout(()=>{callHook(this.hooks,"report",[e,this.reportStack[e]]),this.reportStack[e]=null},200)):this.reportStack[e].push(t)}addPlugin(e,...t){assert(this.installedPlugins.has(e),"Don't repeat install plugin"),t.unshift(this),"function"==typeof e.install?e.install.apply(e,t):e.apply(null,t),this.installedPlugins.add(e)}update(e){assert(isUndef(e),"Missing component");const t=this.depComponents.get(e);isPlainObject(e.SDKConfig)&&handleConfigHooks.update(this,e,e.SDKConfig,t),callHook(this.hooks,"update",[this,e,t])}}function autoReport(e,t={}){assert("string"!=typeof t.url,"The request url must be a string.\n\n --- from [autoReport] plugin\n"),assert(!("projectName"in t),"Must defined [projectName] field.");const o=["GET","POST"],r=o=>{return{bm:o,uid:"function"==typeof t.uid?t.uid():"",tp:0,sp:"stat",sc:t.projectName,t:Date.parse(new Date),unid:"za-ad10c-16d630b0690",p:e.router.getCurrentPage().route}};function n(e,n){let a=[],i="GET";switch(e){case 11:case 130:case 21:break;case 20:a=n.map(e=>({...r("time"),exd:{initToRequestTime:e}}));break;case 22:a=n.map(e=>({...r("time"),exd:{renderContentTime:e}}));break;case 23:a=n.map(e=>({...r("time"),exd:{renderAllContentTime:e}}));break;case 30:break;default:if("function"==typeof t.callback){const{data:o,method:s,module:p}=t.callback(e,n);assert(!Array.isArray(a),"[data] must be an Array\n\n --- from [autoReport] plugin\n"),assert("string"!=typeof p,"[module] must be an String\n\n --- from [autoReport] plugin\n"),i=s,a=o.map(e=>({...r(p),exd:e}))}}o.includes(i)&&a.length>0&&a.forEach(e=>{wx.request({method:i,data:e,url:t.url,header:t.header||{}})})}isUndef(e.hooks.report)||"function"==typeof e.hooks.report&&"defaultReport"!==e.hooks.report.name?e.hooks.report=createWraper(e.hooks.report,n):e.hooks.report=n}function firstScreenTime(e){let t=null;const o=e.hooks;isUndef(o.app)&&(o.app={}),isUndef(o.page)&&(o.page={}),e.addCode("initToRequestTime",20),e.addCode("showTime",21),e.addCode("renderContentTime",22),e.addCode("renderAllContentTime",23),o.app.onLaunch=createWraper(o.app.onLaunch,(e,o,r)=>{t=r.path,e.time("initToRequestTime")}),o.app.onShow=createWraper(o.app.onShow,()=>{isUndef(t)||e.time("renderContentTime"),e.time("renderAllContentTime"),e.time("showTime")}),o.app.onHide=createWraper(o.app.onHide,()=>{const t=e.timeEnd("showTime");e.report("showTime",t)}),o.app.onError=createWraper(o.app.onError,t=>{e.report("catchGlobalError",t)}),isUndef(t)||(o.page.onReady=createWraper(o.app.onReady,(e,o)=>{if(t===o.route){const t=e.timeEnd("renderContentTime");e.report("renderContentTime",t)}})),e.firstScreen={initToRequest:once(()=>{const t=e.timeEnd("initToRequestTime");e.report("initToRequestTime",t)}),renderAllTime:once(()=>{const t=e.timeEnd("renderAllContentTime");e.report("renderAllContentTime",t)})}}var index=Object.freeze({autoReport:autoReport,firstScreenTime:firstScreenTime});const handleRouter=(e,t,o={})=>{const{fail:r,success:n}=o,a={to:o.url,from:t.getCurrentPage().route};o.success=createWraper(n,()=>t.report(e,a)),o.fail=createWraper(r,o=>{a.error=o,t.reportError(e,a)})};var overideWX=(e,t)=>{t("reLaunch",t=>handleRouter("reLaunch",e.router,t)),t("switchTab",t=>handleRouter("switchTab",e.router,t)),t("navigateTo",t=>handleRouter("navigateTo",e.router,t)),t("redirectTo",t=>handleRouter("redirectTo",e.router,t))};const SDKCfgNamespace="SDKConfig",pageLifeTime="onLoad,onShow,onReady,onHide,onUnload",componentLifeTime="created,attached,ready,moved,detached",appLifeTime="onLaunch,onShow,onHide,onError,onPageNotFound";function overideComponent(e,t,o){const r=t[SDKCfgNamespace],n=isPlainObject(r),a=(t,a,i)=>{let s,p;if(o?(s=e.hooks.page,p=handleConfigHooks.page):(s=e.hooks.component,p=handleConfigHooks.component),"onLoad"===t||"attached"===t){a.SDK=e,e.depComponents.set(a,o);const t=a.setData;a.setData=function(o,r){t.call(this,o,createWraper(r,()=>{e.update(this)}))}}"onUnload"!==t&&"detached"!==t||e.depComponents.delete(a),n&&(a[SDKCfgNamespace]=r,callHook(p,"onLoad",[e,a,i,r,o])),callHook(s,t,[e,a,i])};if(o)pageLifeTime.split(",").forEach(e=>{t[e]=createWraper(t[e],(function(t){a(e,this,t)}))});else{t.lifetimes=t.lifetimes||{};const e=e=>t[e]||t.lifetimes[e],o=(e,o)=>t[e]=t.lifetimes[e]=o;componentLifeTime.split(",").forEach(t=>{o(t,createWraper(e(t),(function(e){a(t,this,e)})))})}return t}function overideApp(e,t){const o=t[SDKCfgNamespace],r=isPlainObject(o);return appLifeTime.split(",").forEach(n=>{t[n]=createWraper(t[n],(function(t){r&&(this[SDKCfgNamespace]=o,callHook(handleConfigHooks.app,n,[e,this,t,o,isPage])),callHook(e.hooks.app,n,[e,this,t])}))}),t}function overideWxClass(e,t){const o={};overideWX(e,(e,r)=>{assert(!(e in t),"Only allowed to rewrite."),assert(e in o,`${e} has been rewritten`),o[e]=createWraper(t[e],r)}),wx=Object.assign({},t,o)}let isInitComplete=!1;const nativeWX=wx,nativeApp=App,nativePage=Page,nativeComponent=Component,filterOpts=e=>Object.assign({hooks:{report:function(){warn("you need defined [report] hook function.")}}},e);function initSDK(e){isInitComplete&&warn("Can't allow repeat initialize.");const t=new SDK(filterOpts(e||{}));return Page=function(e){return e=overideComponent(t,e,!0),nativePage.call(this,e)},Component=function(e){return e=overideComponent(t,e,!1),nativeComponent.call(this,e)},App=function(e){return e=overideApp(t,e),nativeApp.call(this,e)},overideWxClass(t,nativeWX),isInitComplete=!0,t}exports.default=initSDK,exports.plugins=index;
