"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const warn=(e,t)=>{if(e=`\n[SDK warn]: ${e}\n\n`,!t)throw new Error(e);console.warn(e)},assert=(e,t)=>{e&&warn(t)},isUndef=e=>null==e,isFn=e=>"function"==typeof e,once=e=>{let t=!0;return function(...o){t&&(t=!1,e.apply(this,o))}},callHook=(e,t,o)=>e&&"function"==typeof e[t]?e[t].apply(e,o):null,createWraper=(e,t)=>(function(...o){if(t.apply(this,o),"function"==typeof e)return e.apply(this,o)}),isPlainObject=e=>{if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);if(null===t)return!0;let o=t;for(;null!==Object.getPrototypeOf(o);)o=Object.getPrototypeOf(o);return t===o};class Router{constructor(e){this.sdk=e}report(e,t){t.type=e,this.sdk.report("router",t)}reportError(e,t){t.type=e,this.sdk.report("routerError",t)}getCurrentPage(){const e=getCurrentPages();return Array.isArray(e)&&e.length>0?e[e.length-1]:null}}var handleConfigHooks={app:{},page:{onLoad(e,t,o,n){const r=n.onLoad;for(const o in r)r.hasOwnProperty(o)&&"function"==typeof r[o]&&r[o](e,t)},onShow(e,t,o,n){const r=n.onShow;for(const o in r)r.hasOwnProperty(o)&&"function"==typeof r[o]&&r[o](e,t)},onUnLoad(e,t,o,n){}},component:{},update({fnName:e,params:t,sdk:o,SDKConfig:n,component:r,isPage:a,isSetData:i}){if(t=isUndef(t)?{}:t,i){if(!isPlainObject(n.updateAfterSetData))return;for(const e in n.updateAfterSetData)n.updateAfterSetData.hasOwnProperty(e)&&n.updateAfterSetData[e]()}else if(isPlainObject(n.update))if(isUndef(e))for(const e in n.update)n.update.hasOwnProperty(e)&&n.update[e](t);else assert(!isFn(n.update[e]),`Can't find function: ${e}`),n.update[e](t)}};const reportCodes={catchGlobalError:11,routerError:130,router:30},addCode=(e,t)=>{assert(e in reportCodes,`The [${e}] already exists.`),reportCodes[e]=t},getCode=e=>(assert(!(e in reportCodes),`Code [${e}] is does not exist.`),reportCodes[e]);class SDK{constructor(e){this.opts=e,this.reportStack={},this.hooks=e.hooks,this.depComponents=new Map,this.router=new Router(this),this.reportCodes=reportCodes,this.installedPlugins=new Set,this.timeStack=Object.create(null)}once(e){return once(e)}wraper(e,t){return createWraper(e,t)}addCode(e,t){addCode(e,t)}time(e){"string"==typeof e&&(isUndef(this.timeStack[e])?this.timeStack[e]=Date.now():warn(`Timer [${e}] already exists.`,!0))}timeEnd(e,t){if("string"==typeof e){if(!isUndef(this.timeStack[e])){const o=Date.now()-this.timeStack[e];return"function"==typeof t&&t(o),this.timeStack[e]=null,o}warn(`Timer [${e}] does not exist.`,!0)}return null}report(e,t){e=getCode(e),isUndef(this.reportStack[e])?(this.reportStack[e]=[t],setTimeout(()=>{callHook(this.hooks,"report",[e,this.reportStack[e]]),this.reportStack[e]=null},200)):isUndef(t)||this.reportStack[e].push(t)}addPlugin(e,...t){assert(this.installedPlugins.has(e),"Don't repeat install plugin"),t.unshift(this),"function"==typeof e.install?e.install.apply(e,t):e.apply(null,t),this.installedPlugins.add(e)}update(e,t,o,n){assert(isUndef(e),"Missing component");const r=this.depComponents.get(e);isPlainObject(e.SDKConfig)&&handleConfigHooks.update({fnName:t,params:o,sdk:this,SDKConfig:e.SDKConfig,component:e,isPage:r,isSetData:n}),callHook(this.hooks,"update",[this,e,r])}}function autoReport(e,t={}){assert("string"!=typeof t.url,"The request url must be a string.\n\n --- from [autoReport] plugin\n"),assert(!("projectName"in t),"Must defined [projectName] field.");const o=["GET","POST"],n=o=>{return{bm:o,uid:"function"==typeof t.uid?t.uid():"",tp:0,sp:"stat",sc:t.projectName,t:Date.parse(new Date),unid:"za-ad10c-16d630b0690",p:e.router.getCurrentPage().route}};function r(e,r){let a=[],i="GET";switch(e){case 11:case 130:case 21:break;case 20:a=r.map(e=>({...n("time"),exd:{initToRequestTime:e}}));break;case 22:a=r.map(e=>({...n("time"),exd:{renderContentTime:e}}));break;case 23:a=r.map(e=>({...n("time"),exd:{renderAllContentTime:e}}));break;case 30:break;default:if("function"==typeof t.callback){const{data:o,method:s,module:p}=t.callback(e,r);assert(!Array.isArray(a),"[data] must be an Array\n\n --- from [autoReport] plugin\n"),assert("string"!=typeof p,"[module] must be an String\n\n --- from [autoReport] plugin\n"),i=s,a=o.map(e=>({...n(p),exd:e}))}}o.includes(i)&&a.length>0&&a.forEach(e=>{wx.request({method:i,data:e,url:t.url,header:t.header||{}})})}isUndef(e.hooks.report)||"function"==typeof e.hooks.report&&"defaultReport"!==e.hooks.report.name?e.hooks.report=createWraper(e.hooks.report,r):e.hooks.report=r}function firstScreenTime(e){let t=null;const o=e.hooks;isUndef(o.app)&&(o.app={}),isUndef(o.page)&&(o.page={}),e.addCode("initToRequestTime",20),e.addCode("showTime",21),e.addCode("renderContentTime",22),e.addCode("renderAllContentTime",23),o.app.onLaunch=createWraper(o.app.onLaunch,(e,o,n)=>{t=n.path,e.time("initToRequestTime")}),o.app.onShow=createWraper(o.app.onShow,()=>{isUndef(t)||e.time("renderContentTime"),e.time("renderAllContentTime"),e.time("showTime")}),o.app.onHide=createWraper(o.app.onHide,()=>{const t=e.timeEnd("showTime");e.report("showTime",t)}),o.app.onError=createWraper(o.app.onError,t=>{e.report("catchGlobalError",t)}),o.page.onReady=createWraper(o.app.onReady,once((e,o)=>{if(t===o.route){const t=e.timeEnd("renderContentTime");e.report("renderContentTime",t)}})),e.firstScreen={initToRequest:once(()=>{const t=e.timeEnd("initToRequestTime");e.report("initToRequestTime",t)}),renderAllTime:once(()=>{const t=e.timeEnd("renderAllContentTime");e.report("renderAllContentTime",t)})}}function tapReport(e,t={}){assert("string"!=typeof t.url,"The request url must be a string.\n\n --- from [autoReport] plugin\n");const o=e.hooks;isUndef(o.app)&&(o.app={}),isUndef(o.page)&&(o.page={}),e.addCode("tapEvent",40),o.page.overrideBefore=createWraper(o.page.overrideBefore,(function(e,o){o.tapReport=function(e){let n=e.target.dataset.zareport;if(isUndef(n))return;assert("string"!=typeof n,"The zareport must be a string.\n\n --- from [tap-report] plugin\n"),assert(!o.SDKConfig.reportData||!o.SDKConfig.reportData.hasOwnProperty(n),`Unrecognized report params key ${n}. --- from [tap-report] plugin`);const r={exd:JSON.stringify(o.SDKConfig.reportData[n]||{})},a=genCommonOptions(),i="?"+urlEncode(Object.assign(a,r)).slice(1);wx.request({url:t.url+i,success:e=>{}})}}))}function genCommonOptions(){getApp();const e=Object.create(null);let t=Math.random().toString().slice(-6);t=parseInt(t).toString(16);let o=Date.parse(new Date),n=`za-${t}-${parseInt(o).toString(16)}`;return e.unid=n,e.t=(new Date).getTime(),e.uid=wx.getStorageSync("__uuid")||"",e.p=getCurrentPages().route||"pages/index/index",e.sc="mp",e.bm="mingqi",e.sp="stat",e.tp=2,e}function urlEncode(e,t){if(isUndef(e))return"";let o="";const n=typeof e;if("string"===n||"number"===n||"boolean"===n)o+="&"+t+"="+encodeURIComponent(e);else{assert("object"!==n,`Unrecognized report param type ${n}. --- from [tap-report] plugin`);for(let t in e)o+=urlEncode(e[t],t)}return o}var index=Object.freeze({autoReport:autoReport,firstScreenTime:firstScreenTime,tapReport:tapReport});const handleRouter=(e,t,o={})=>{const{fail:n,success:r}=o,a={to:o.url,from:t.getCurrentPage().route};o.success=createWraper(r,()=>t.report(e,a)),o.fail=createWraper(n,o=>{a.error=o,t.reportError(e,a)})};var overideWX=(e,t)=>{t("reLaunch",t=>handleRouter("reLaunch",e.router,t)),t("switchTab",t=>handleRouter("switchTab",e.router,t)),t("navigateTo",t=>handleRouter("navigateTo",e.router,t)),t("redirectTo",t=>handleRouter("redirectTo",e.router,t))};const SDKCfgNamespace="SDKConfig",pageLifeTime="onLoad,onShow,onReady,onHide,onUnload",componentLifeTime="created,attached,ready,moved,detached",appLifeTime="onLaunch,onShow,onHide,onError,onPageNotFound";function overideComponent(e,t,o){const n=t[SDKCfgNamespace],r=isPlainObject(n),a=(t,a,i)=>{let s,p;if(o?(s=e.hooks.page,p=handleConfigHooks.page):(s=e.hooks.component,p=handleConfigHooks.component),"onLoad"===t||"attached"===t){a.SDK=e,e.depComponents.set(a,o);const t=a.setData;a.setData=function(o,n){t.call(this,o,createWraper(n,()=>{e.update(this,null,null,!0)}))}}"onUnload"!==t&&"detached"!==t||e.depComponents.delete(a),r&&(a[SDKCfgNamespace]=n,callHook(p,"onLoad",[e,a,i,n,o])),callHook(s,t,[e,a,i])};if(callHook(e.hooks.page,"overrideBefore",[e,t]),callHook(e.hooks.component,"overrideBefore",[e,t]),o)pageLifeTime.split(",").forEach(e=>{t[e]=createWraper(t[e],(function(t){a(e,this,t)}))});else{t.lifetimes=t.lifetimes||{};const e=e=>t[e]||t.lifetimes[e],o=(e,o)=>t[e]=t.lifetimes[e]=o;componentLifeTime.split(",").forEach(t=>{o(t,createWraper(e(t),(function(e){a(t,this,e)})))})}return t}function overideApp(e,t){const o=t[SDKCfgNamespace],n=isPlainObject(o);return appLifeTime.split(",").forEach(r=>{t[r]=createWraper(t[r],(function(t){n&&(this[SDKCfgNamespace]=o,callHook(handleConfigHooks.app,r,[e,this,t,o,isPage])),callHook(e.hooks.app,r,[e,this,t])}))}),t}function overideWxClass(e,t){const o={};overideWX(e,(e,n)=>{assert(!(e in t),"Only allowed to rewrite."),assert(e in o,`${e} has been rewritten`),o[e]=createWraper(t[e],n)}),wx=Object.assign({},t,o)}let isInitComplete=!1;const nativeWX=wx,nativeApp=App,nativePage=Page,nativeComponent=Component,filterOpts=e=>Object.assign({hooks:{report:function(){warn("you need defined [report] hook function.")}}},e);function initSDK(e){isInitComplete&&warn("Can't allow repeat initialize.");const t=new SDK(filterOpts(e||{}));return Page=function(e){return e=overideComponent(t,e,!0),nativePage.call(this,e)},Component=function(e){return e=overideComponent(t,e,!1),nativeComponent.call(this,e)},App=function(e){return e=overideApp(t,e),nativeApp.call(this,e)},overideWxClass(t,nativeWX),isInitComplete=!0,t}exports.default=initSDK,exports.plugins=index;
